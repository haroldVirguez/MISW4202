<div class="auth-container">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-8">
        <div class="auth-card">
          <div class="auth-header">
            <h1 class="auth-title">
              <i class="fas fa-shield-alt"></i>
              Sistema de Autenticación y Autorización
            </h1>
            <p class="auth-subtitle">Gestión de usuarios, firmas digitales y validación</p>
          </div>

          <div class="auth-nav">
            <button 
              class="nav-btn" 
              [class.active]="showLogin"
              (click)="toggleView('login')">
              <i class="fas fa-sign-in-alt"></i> Login
            </button>
            <button 
              class="nav-btn" 
              [class.active]="showSignup"
              (click)="toggleView('signup')">
              <i class="fas fa-user-plus"></i> Registro
            </button>
            <button 
              class="nav-btn" 
              [class.active]="showSignature"
              (click)="toggleView('signature')"
              [disabled]="!isLoggedIn">
              <i class="fas fa-signature"></i> Firmar
            </button>
            <button 
              class="nav-btn" 
              [class.active]="showValidation"
              (click)="toggleView('validation')">
              <i class="fas fa-check-circle"></i> Validar
            </button>
          </div>

          <div *ngIf="message" class="message-container">
            <div [ngClass]="getMessageClass()">
              <i class="fas" [class.fa-info-circle]="messageType === 'info'"
                          [class.fa-check-circle]="messageType === 'success'"
                          [class.fa-exclamation-circle]="messageType === 'error'"></i>
              {{ message }}
            </div>
          </div>

          <div *ngIf="isLoggedIn" class="auth-status">
            <div class="user-info">
              <i class="fas fa-user"></i>
              <span>Conectado como: <strong>{{ currentUser?.nombre }}</strong></span>
              <span class="user-roles">Roles: {{ currentUser?.roles }}</span>
            </div>
            <button class="btn btn-logout" (click)="logout()">
              <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
            </button>
          </div>

          <div *ngIf="showLogin" class="auth-form">
            <h3><i class="fas fa-sign-in-alt"></i> Iniciar Sesión</h3>
            <form (ngSubmit)="login()">
              <div class="form-group">
                <label for="login-nombre">Usuario</label>
                <input 
                  type="text" 
                  id="login-nombre"
                  class="form-control"
                  [(ngModel)]="loginForm.nombre" 
                  name="nombre"
                  required>
              </div>
              <div class="form-group">
                <label for="login-contrasena">Contraseña</label>
                <input 
                  type="password" 
                  id="login-contrasena"
                  class="form-control"
                  [(ngModel)]="loginForm.contrasena" 
                  name="contrasena"
                  required>
              </div>
              <button 
                type="submit" 
                class="btn btn-primary btn-block"
                [disabled]="loginLoading">
                <i class="fas fa-spinner fa-spin" *ngIf="loginLoading"></i>
                <i class="fas fa-sign-in-alt" *ngIf="!loginLoading"></i>
                {{ loginLoading ? 'Iniciando...' : 'Iniciar Sesión' }}
              </button>
            </form>
          </div>

          <div *ngIf="showSignup" class="auth-form">
            <h3><i class="fas fa-user-plus"></i> Registrar Usuario</h3>
            <form (ngSubmit)="signup()">
              <div class="form-group">
                <label for="signup-nombre">Usuario</label>
                <input 
                  type="text" 
                  id="signup-nombre"
                  class="form-control"
                  [(ngModel)]="signupForm.nombre" 
                  name="nombre"
                  required>
              </div>
              <div class="form-group">
                <label for="signup-contrasena">Contraseña</label>
                <input 
                  type="password" 
                  id="signup-contrasena"
                  class="form-control"
                  [(ngModel)]="signupForm.contrasena" 
                  name="contrasena"
                  required>
              </div>
              <div class="form-group">
                <label for="signup-roles">Roles</label>
                <select 
                  id="signup-roles"
                  class="form-control"
                  [(ngModel)]="signupForm.roles" 
                  name="roles">
                  <option value="user">Usuario</option>
                  <option value="admin">Administrador</option>
                  <option value="user,admin">Usuario y Admin</option>
                </select>
              </div>
              <button 
                type="submit" 
                class="btn btn-success btn-block"
                [disabled]="signupLoading">
                <i class="fas fa-spinner fa-spin" *ngIf="signupLoading"></i>
                <i class="fas fa-user-plus" *ngIf="!signupLoading"></i>
                {{ signupLoading ? 'Creando...' : 'Registrar Usuario' }}
              </button>
            </form>
          </div>

          <div *ngIf="showSignature" class="auth-form">
            <h3><i class="fas fa-signature"></i> Generar Firma Digital</h3>

            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Entrega ID</label>
                <input class="form-control" [(ngModel)]="signForm.entrega_id" name="entrega_id">
              </div>
              <div class="col-md-4">
                <label class="form-label">Pedido ID</label>
                <input class="form-control" [(ngModel)]="signForm.pedido_id" name="pedido_id">
              </div>
              <div class="col-md-12">
                <label class="form-label">Dirección</label>
                <input class="form-control" [(ngModel)]="signForm.direccion" name="direccion" placeholder="Calle 123 #45-67, Bogotá">
              </div>
              <div class="col-md-6">
                <label class="form-label">Nombre quien recibe</label>
                <input class="form-control" [(ngModel)]="signForm.nombre_recibe" name="nombre_recibe">
              </div>
              <div class="col-md-6">
                <label class="form-label">Firma del receptor</label>
                <input class="form-control" [(ngModel)]="signForm.firma_recibe" name="firma_recibe">
              </div>
            </div>

            <div class="d-flex gap-2 mt-3">
              <button class="btn btn-outline-secondary" (click)="setExamplePayload()">
                <i class="fas fa-magic"></i> Cargar ejemplo
              </button>
              <button class="btn btn-primary" (click)="generateSignature()" [disabled]="signatureLoading || !isLoggedIn">
                <i class="fas fa-spinner fa-spin" *ngIf="signatureLoading"></i>
                <i class="fas fa-pen-fancy" *ngIf="!signatureLoading"></i>
                {{ signatureLoading ? 'Firmando…' : 'Firmar' }}
              </button>
              <button class="btn btn-outline-success" (click)="useLastSignatureInValidation()" [disabled]="!signatureData.firma">
                <i class="fas fa-arrow-right"></i> Usar en Validación
              </button>
            </div>

            <div class="mt-3">
              <label class="form-label">Payload a firmar (JSON)</label>
              <textarea class="form-control" rows="8" [(ngModel)]="signatureData.payload" name="signature_payload"
                        placeholder='{"direccion": "...", "nombre_recibe": "...", "firma_recibe": "...", "pedido_id": "...", "usuario_id": 1, "entrega_id": 1}'></textarea>
            </div>

            <div class="mt-3">
              <label class="form-label">Firma (HMAC)</label>
              <input class="form-control" [value]="signatureData.firma" readonly>
              <small class="text-muted" *ngIf="signatureData.timestamp">timestamp: {{ signatureData.timestamp }}</small>
            </div>
          </div>

          <div *ngIf="showValidation" class="auth-form">
            <h3><i class="fas fa-check-circle"></i> Validar Firma Digital</h3>

            <div class="mb-3">
              <label class="form-label">Payload (JSON)</label>
              <textarea class="form-control" rows="8" [(ngModel)]="validationData.payload" name="validation_payload"
                        placeholder='Pegue aquí el mismo JSON que se firmó'></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label">Firma (HMAC)</label>
              <input class="form-control" [(ngModel)]="validationData.firma" name="validation_firma" placeholder="pegar firma aquí">
            </div>

            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary" (click)="useLastSignatureInValidation()" [disabled]="!signatureData.firma">
                <i class="fas fa-paste"></i> Pegar último firmado
              </button>
              <button class="btn btn-success" (click)="validateSignature()" [disabled]="validationLoading">
                <i class="fas fa-spinner fa-spin" *ngIf="validationLoading"></i>
                <i class="fas fa-check" *ngIf="!validationLoading"></i>
                {{ validationLoading ? 'Validando…' : 'Validar' }}
              </button>
            </div>

            <div class="mt-3" *ngIf="validationData.resultado">
              <span class="badge" [ngClass]="validationData.resultado.firma_valida ? 'badge-success' : 'badge-danger'">
                {{ validationData.resultado.firma_valida ? '✅ VÁLIDA' : '❌ INVÁLIDA' }}
              </span>
              <pre class="mt-2 bg-light p-2">{{ validationData.resultado | json }}</pre>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
